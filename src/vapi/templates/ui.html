{% extends "base.html" %}

{% block title %}AI Chat - VAPI AI Assistant{% endblock %}

{% block extra_css %}
<style>
    .chat-container {
        height: 600px;
        background-color: white;
        border-radius: 0.5rem;
        padding: 1rem;
        overflow-y: auto;
        border: 1px solid #dee2e6;
    }
    
    .message {
        margin-bottom: 1rem;
        animation: fadeIn 0.3s ease-in;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .user-message {
        text-align: right;
    }
    
    .user-message .message-bubble {
        display: inline-block;
        background-color: #007bff;
        color: white;
        padding: 0.75rem 1rem;
        border-radius: 1rem 1rem 0.25rem 1rem;
        max-width: 70%;
        word-wrap: break-word;
    }
    
    .ai-message {
        text-align: left;
    }
    
    .ai-message .message-bubble {
        display: inline-block;
        background-color: #f8f9fa;
        color: #333;
        padding: 0.75rem 1rem;
        border-radius: 1rem 1rem 1rem 0.25rem;
        max-width: 70%;
        word-wrap: break-word;
        border: 1px solid #e9ecef;
    }
    
    .message-info {
        font-size: 0.75rem;
        color: #6c757d;
        margin-top: 0.25rem;
    }
    
    .typing-indicator {
        display: none;
        text-align: left;
        margin-bottom: 1rem;
    }
    
    .typing-dots {
        display: inline-block;
        background-color: #f8f9fa;
        padding: 0.75rem 1rem;
        border-radius: 1rem;
        border: 1px solid #e9ecef;
    }
    
    .typing-dots::after {
        content: '●●●';
        animation: typing 1.5s infinite;
        color: #007bff;
    }
    
    @keyframes typing {
        0%, 20% { opacity: 0.2; }
        50% { opacity: 1; }
        100% { opacity: 0.2; }
    }
    
    .input-section {
        border-top: 1px solid #dee2e6;
        padding-top: 1rem;
        margin-top: 1rem;
    }
    
    .model-selector {
        max-height: 200px;
        overflow-y: auto;
    }
    
    .provider-badge {
        font-size: 0.7rem;
        padding: 0.2rem 0.4rem;
        border-radius: 0.25rem;
    }
    
    .provider-ollama { background-color: #e3f2fd; color: #1976d2; }
    .provider-openrouter { background-color: #f3e5f5; color: #7b1fa2; }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-9">
        <!-- Chat Interface -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-comments me-2"></i>
                    AI Chat Interface
                </h5>
                <div class="d-flex align-items-center gap-2">
                    <span class="badge bg-success" id="model-indicator">
                        {{ current_model or 'Loading...' }}
                    </span>
                    <button class="btn btn-sm btn-outline-secondary" id="clear-chat">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <!-- Chat Messages -->
                <div class="chat-container" id="chat-container">
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-robot fa-2x mb-2"></i>
                        <p class="mb-0">Start a conversation with the AI assistant!</p>
                        <small>Type your message below or select a different model from the sidebar.</small>
                    </div>
                </div>
                
                <!-- Typing Indicator -->
                <div class="typing-indicator" id="typing-indicator">
                    <div class="typing-dots"></div>
                    <div class="message-info">AI is thinking...</div>
                </div>
                
                <!-- Input Section -->
                <div class="input-section">
                    <form id="chat-form" class="d-flex gap-2">
                        <input type="text" id="message-input" class="form-control" 
                               placeholder="Type your message..." autocomplete="off">
                        <button type="submit" id="send-button" class="btn btn-primary">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3">
        <!-- Model Selection -->
        <div class="card mb-3">
            <div class="card-header">
                <i class="fas fa-brain me-2"></i>
                AI Models
            </div>
            <div class="card-body">
                <!-- Provider Switcher -->
                <div class="mb-3">
                    <label class="form-label">Provider:</label>
                    <select class="form-select form-select-sm" id="provider-select">
                        <option value="ollama" {{ 'selected' if current_provider == 'ollama' else '' }}>
                            Ollama (Local)
                        </option>
                        <option value="openrouter" {{ 'selected' if current_provider == 'openrouter' else '' }}>
                            OpenRouter (Cloud)
                        </option>
                    </select>
                </div>
                
                <!-- Model List -->
                <div id="model-list" class="model-selector">
                    <div class="text-center">
                        <div class="spinner-border spinner-border-sm text-primary" role="status">
                            <span class="visually-hidden">Loading models...</span>
                        </div>
                        <p class="mt-2 mb-0"><small>Loading models...</small></p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- System Info -->
        <div class="card mb-3">
            <div class="card-header">
                <i class="fas fa-info-circle me-2"></i>
                System Info
            </div>
            <div class="card-body">
                <div id="system-info">
                    <div class="text-center">
                        <div class="spinner-border spinner-border-sm text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Chat Controls -->
        <div class="card">
            <div class="card-header">
                <i class="fas fa-cogs me-2"></i>
                Controls
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-sm btn-outline-warning" id="clear-chat-btn">
                        <i class="fas fa-trash me-1"></i>
                        Clear Chat
                    </button>
                    <button class="btn btn-sm btn-outline-info" id="export-chat-btn">
                        <i class="fas fa-download me-1"></i>
                        Export Chat
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" id="refresh-models-btn">
                        <i class="fas fa-sync me-1"></i>
                        Refresh Models
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let chatHistory = [];
let currentModel = '{{ current_model or "" }}';
let currentProvider = '{{ current_provider or "ollama" }}';

// Initialize the UI
document.addEventListener('DOMContentLoaded', function() {
    loadModels();
    loadSystemInfo();
    
    // Set up event listeners
    document.getElementById('chat-form').addEventListener('submit', sendMessage);
    document.getElementById('provider-select').addEventListener('change', switchProvider);
    document.getElementById('clear-chat-btn').addEventListener('click', clearChat);
    document.getElementById('clear-chat').addEventListener('click', clearChat);
    document.getElementById('export-chat-btn').addEventListener('click', exportChat);
    document.getElementById('refresh-models-btn').addEventListener('click', loadModels);
    
    // Focus message input
    document.getElementById('message-input').focus();
});

// Load available models
async function loadModels() {
    try {
        const response = await fetch('/personas');
        const models = await response.json();
        
        const modelList = document.getElementById('model-list');
        
        if (models && models.length > 0) {
            modelList.innerHTML = models.map(model => `
                <div class="form-check mb-2">
                    <input class="form-check-input" type="radio" name="modelSelect" 
                           id="model-${model.name}" value="${model.name}"
                           ${model.name === currentModel ? 'checked' : ''}>
                    <label class="form-check-label d-flex justify-content-between align-items-center" 
                           for="model-${model.name}">
                        <div>
                            <div class="fw-bold">${model.display_name || model.name}</div>
                            ${model.description ? `<small class="text-muted">${model.description}</small>` : ''}
                        </div>
                        ${model.is_jamie_model ? 
                            '<span class="badge jamie-model">Jamie</span>' : 
                            '<span class="badge regular-model">Model</span>'
                        }
                    </label>
                </div>
            `).join('');
            
            // Add event listeners for model selection
            document.querySelectorAll('input[name="modelSelect"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    if (this.checked) {
                        switchModel(this.value);
                    }
                });
            });
        } else {
            modelList.innerHTML = '<p class="text-muted mb-0">No models available</p>';
        }
    } catch (error) {
        console.error('Error loading models:', error);
        document.getElementById('model-list').innerHTML = 
            '<p class="text-danger mb-0">Error loading models</p>';
    }
}

// Load system info
async function loadSystemInfo() {
    try {
        const response = await fetch('/status');
        const info = await response.json();
        
        const systemInfo = document.getElementById('system-info');
        systemInfo.innerHTML = `
            <div class="row g-2">
                <div class="col-6">
                    <div class="text-center">
                        <i class="fas fa-circle ${info.model_available ? 'status-online' : 'status-offline'}"></i>
                        <div><small>Model</small></div>
                        <strong>${info.model_available ? 'Ready' : 'Offline'}</strong>
                    </div>
                </div>
                <div class="col-6">
                    <div class="text-center">
                        <i class="fas fa-server ${info.status === 'online' ? 'status-online' : 'status-offline'}"></i>
                        <div><small>System</small></div>
                        <strong>${info.status === 'online' ? 'Online' : 'Offline'}</strong>
                    </div>
                </div>
                <div class="col-12">
                    <hr class="my-2">
                    <small class="text-muted">
                        Provider: <strong>${info.current_provider || 'Unknown'}</strong><br>
                        Models: <strong>${info.total_models || 0}</strong>
                    </small>
                </div>
            </div>
        `;
    } catch (error) {
        console.error('Error loading system info:', error);
        document.getElementById('system-info').innerHTML = 
            '<p class="text-danger mb-0"><small>Error loading system info</small></p>';
    }
}

// Switch AI provider
async function switchProvider() {
    const newProvider = document.getElementById('provider-select').value;
    
    try {
        showToast('Switching provider...', 'info');
        
        const response = await fetch('/switch-provider', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ provider: newProvider })
        });
        
        const result = await response.json();
        
        if (result.success) {
            currentProvider = newProvider;
            showToast(`Switched to ${newProvider}`, 'success');
            loadModels(); // Reload models for new provider
            loadSystemInfo();
        } else {
            showToast(`Failed to switch provider: ${result.message}`, 'danger');
            // Reset the select back to previous value
            document.getElementById('provider-select').value = currentProvider;
        }
    } catch (error) {
        console.error('Error switching provider:', error);
        showToast('Error switching provider', 'danger');
        document.getElementById('provider-select').value = currentProvider;
    }
}

// Switch model
function switchModel(modelName) {
    currentModel = modelName;
    document.getElementById('model-indicator').textContent = modelName;
    showToast(`Switched to ${modelName}`, 'info');
}

// Send message
async function sendMessage(e) {
    e.preventDefault();
    
    const messageInput = document.getElementById('message-input');
    const message = messageInput.value.trim();
    
    if (!message) return;
    
    // Add user message to chat
    addMessage('user', message);
    messageInput.value = '';
    
    // Show typing indicator
    document.getElementById('typing-indicator').style.display = 'block';
    
    // Disable send button
    const sendButton = document.getElementById('send-button');
    sendButton.disabled = true;
    sendButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    
    try {
        const response = await fetch('/chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                message: message,
                model: currentModel
            })
        });
        
        const result = await response.json();
        
        // Hide typing indicator
        document.getElementById('typing-indicator').style.display = 'none';
        
        if (result.success) {
            // Add AI response to chat
            addMessage('ai', result.ai_response, result.model_used);
            
            // Update model indicator if different
            if (result.model_used !== currentModel) {
                document.getElementById('model-indicator').textContent = result.model_used;
                currentModel = result.model_used;
            }
        } else {
            addMessage('ai', `Error: ${result.error}`, 'error');
            showToast('Error getting AI response', 'danger');
        }
    } catch (error) {
        console.error('Error sending message:', error);
        document.getElementById('typing-indicator').style.display = 'none';
        addMessage('ai', 'Sorry, I encountered an error. Please try again.', 'error');
        showToast('Network error', 'danger');
    }
    
    // Re-enable send button
    sendButton.disabled = false;
    sendButton.innerHTML = '<i class="fas fa-paper-plane"></i>';
    messageInput.focus();
}

// Add message to chat
function addMessage(role, content, model = null) {
    const chatContainer = document.getElementById('chat-container');
    const messageDiv = document.createElement('div');
    const timestamp = new Date();
    
    messageDiv.className = `message ${role}-message`;
    
    const bubble = document.createElement('div');
    bubble.className = 'message-bubble';
    bubble.textContent = content;
    
    const info = document.createElement('div');
    info.className = 'message-info';
    info.textContent = timestamp.toLocaleTimeString();
    if (model && role === 'ai') {
        info.textContent += ` • ${model}`;
    }
    
    messageDiv.appendChild(bubble);
    messageDiv.appendChild(info);
    
    chatContainer.appendChild(messageDiv);
    
    // Store in history
    chatHistory.push({
        role,
        content,
        model,
        timestamp: timestamp.toISOString()
    });
    
    // Scroll to bottom
    chatContainer.scrollTop = chatContainer.scrollHeight;
    
    // Remove welcome message if it exists
    const welcome = chatContainer.querySelector('.text-center.text-muted');
    if (welcome) {
        welcome.remove();
    }
}

// Clear chat
function clearChat() {
    if (confirm('Clear all chat messages?')) {
        chatHistory = [];
        const chatContainer = document.getElementById('chat-container');
        chatContainer.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="fas fa-robot fa-2x mb-2"></i>
                <p class="mb-0">Start a conversation with the AI assistant!</p>
                <small>Type your message below or select a different model from the sidebar.</small>
            </div>
        `;
        showToast('Chat cleared', 'info');
    }
}

// Export chat
function exportChat() {
    if (chatHistory.length === 0) {
        showToast('No messages to export', 'warning');
        return;
    }
    
    const exportData = {
        timestamp: new Date().toISOString(),
        model: currentModel,
        provider: currentProvider,
        messages: chatHistory
    };
    
    const blob = new Blob([JSON.stringify(exportData, null, 2)], { 
        type: 'application/json' 
    });
    
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `chat-export-${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showToast('Chat exported', 'success');
}

// Auto-refresh system info every 30 seconds
setInterval(loadSystemInfo, 30000);
</script>
{% endblock %}
